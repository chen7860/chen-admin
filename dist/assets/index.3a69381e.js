var _=Object.defineProperty;var w=(u,t,e)=>t in u?_(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var p=(u,t,e)=>(w(u,typeof t!="symbol"?t+"":t,e),e);import{P as y}from"./index.d6f853c0.js";import{M as x,o as v,i as D,n as g,t as C,aA as E,cI as b,c5 as F,a as A,K as B,k as R,B as M,j as L}from"./index.40f28117.js";import"./index.4f5af4cb.js";import"./index.4a603b3b.js";import"./useBreakpoint.aac64a46.js";import"./responsiveObserve.c900bce4.js";import"./useSize.d39be33d.js";import"./useWindowSizeFn.8d01d8dc.js";import"./useContentViewHeight.a9642e78.js";import"./index.b7896ea2.js";import"./transButton.cca87ed8.js";import"./ArrowLeftOutlined.e04bc070.js";const I={name:"Pop",setup(){const{proxy:u}=E();return{proxy:u}}},V={id:"info_box",class:"popup-box-wrap"},P={class:"site-content"},S={class:"td-right"},G={class:"td-right"},$={class:"td-right"},j={class:"td-left"},k={class:"td-right"};function N(u,t,e,i,s,a){return v(),D("div",V,[g("div",P,[g("table",null,[g("tr",null,[t[0]||(t[0]=g("td",{class:"td-left"},"\u683C\u70B9\u7F16\u53F7:",-1)),g("td",S,C(i.proxy.$era5data[3]),1)]),g("tr",null,[t[1]||(t[1]=g("td",{class:"td-left"},"\u7ECF\u5EA6:",-1)),g("td",G,C(i.proxy.$era5data[0]),1)]),g("tr",null,[t[2]||(t[2]=g("td",{class:"td-left"},"\u7EAC\u5EA6:",-1)),g("td",$,C(i.proxy.$era5data[1]),1)]),g("tr",null,[g("td",j,C(i.proxy.$era5data.length===5||i.proxy.$era5data.length===7?"\u76DB\u884C\u98CE:":"\u8981\u7D20\u503C:"),1),g("td",k,C(i.proxy.$era5data.length===5||i.proxy.$era5data.length===7?i.proxy.$era5data[4]:i.proxy.$era5data[2]),1)])])])])}var O=x(I,[["render",N],["__scopeId","data-v-78110868"]]);class T{constructor(t){this.gradientColors=[],this.unitValue=.16,this.isRange=!1,this.options={max:40,min:0,step:40,opacity:1,colorScale:["#2966a3","#358ca9","#4A9194","#4D8D7C","#4CA44C","#66A335","#A1873F","#A16C5B","#8C3F5B","#974B90"],valueRange:[],mode:"average"},this.options=Object.assign(this.options,t),this.isRange=this.options.mode==="range",this.alpha=this.options.opacity*255,this.isRange?this.createRangeGradientColorArray():this.createGradientColorArray()}isValue(t){return t!=null}getColor(t){if(this.isValue(t))return this.isRange?this.getRangeColor(t):this.getNormalColor(t)}getNormalColor(t){const e=Math.round((t-this.options.min)/this.unitValue),i=this.gradientColors.length-1;return e>i?this.gradientColors[i]:e<0?this.gradientColors[0]:this.gradientColors[e]}getRangeColor(t){const e=this.options.valueRange;let i=e.length-2,s=e[e.length-2];for(let c=1;c<e.length;c++)if(t<e[c]){i=c-1,s=e[i];break}const a=Math.round((t-s)/this.unitValue[i]),o=this.gradientColors[i],n=o.length-1;return a>n?o[n]:a<0?o[0]:o[a]}createRangeGradientColorArray(){const t=this.options.step,e=this.options.colorScale,i=this.options.valueRange,s=i[0];this.unitValue=[];for(let a=1;a<i.length;a++){const o=i[a]-s;this.unitValue.push(o/t);const n=this._getRangeGradientColor(e[a-1],e[a],t);this.gradientColors.push(n)}}createGradientColorArray(){const t=this.options.step,e=this.options.colorScale,i=Math.floor(this.options.max-this.options.min);this.unitValue=i/((e.length-1)*t);for(let s=0;s<e.length-1;s++)this._getGradientColor(e[s],e[s+1],t)}_getRangeGradientColor(t,e,i,s){let a,o,n,r;s=s||1;const c=function(d){return Math.pow(d/255,s)};t=this.parseColor(t).map(c),e=this.parseColor(e).map(c);const h=this.alpha,l=[];for(a=0;a<i;a++){n=a/(i-1),r=1-n;const d=[];for(o=0;o<3;o++){const f=Math.round(Math.pow(t[o]*r+e[o]*n,1/s)*255);d.push(f)}d.push(h),l.push(d)}return l}_getGradientColor(t,e,i,s){let a,o,n,r;s=s||1;const c=function(l){return Math.pow(l/255,s)};t=this.parseColor(t).map(c),e=this.parseColor(e).map(c);const h=this.alpha;for(a=0;a<i;a++){n=a/(i-1),r=1-n;const l=[];for(o=0;o<3;o++){const d=Math.round(Math.pow(t[o]*r+e[o]*n,1/s)*255);l.push(d)}l.push(h),this.gradientColors.push(l)}}parseColor(t){return t.length===4?t.substr(1).split("").map(function(e){return 17*parseInt(e,16)}):[t.substr(1,2),t.substr(3,2),t.substr(5,2)].map(function(e){return parseInt(e,16)})}}const W=function(u,t,e,i,s,a){const o=1-u,n=1-t,r=o*n,c=u*n,h=o*t,l=u*t,d=e[0]*r+i[0]*c+s[0]*h+a[0]*l,f=e[1]*r+i[1]*c+s[1]*h+a[1]*l;return[d,f,Math.sqrt(d*d+f*f)]};class U{constructor(t){this.options={title:"\u6D77\u9762\u98CE\u573A",name:"\u98CE\u901F",hasPopup:!0,colorCreator:null},this.unit="",this.needBuild=!0,this.legendVal=t.legendVal,this.legendColor=t.legendColor,this.opacity=t.opacity}setOptions(t){this.options=Object.assign(this.options,t),this._colorCreator=new T(this.options.colorCreator),this.unit=this.options.colorCreator?this.options.colorCreator.unit:""}setHeader(t){this.lngStart=t.lo1,this.latStart=t.la1,this.dx=t.dx,this.dy=t.dy,this.nx=t.nx,this.ny=t.ny}addTo(t){this._viewer=t,this._createCanvas(this._viewer.container)}setData(t){this.needBuild=!0,this.data=t}setGrids(t){this.grid=t,this.needBuild=!1}clearPopup(){this._viewer.closePopup()}reload(){this._createCanvas(this._viewer.container)}_createCanvas(){this._canvas||(this._canvas=document.createElement("canvas"))}_removeCanvas(t){this._canvas&&this._canvas.parentNode===t&&(this._canvas=null)}buildGrid(t){const e=t,i=e.header,s=e.data;this.lngStart=i.lo1,this.latStart=i.la1,this.dx=i.dx,this.dy=i.dy;const a=i.nx,o=i.ny;this.nx=a,this.ny=o;const n=[];let r=0;const c=Math.floor(a*this.dx)>=360;for(let h=0;h<o;h++){const l=[];for(let d=0;d<a;d++,r++)l[d]=s[r];c&&l.push(l[0]),n[h]=l}this.grid=n}interpolate(t,e){const i=this.floorMod(t-this.lngStart,360)/this.dx,s=(e-this.latStart)/this.dy,a=Math.floor(i),o=Math.floor(s);let n;if(n=this.grid[o]){const r=n[a];if(this.isValue(r))return r}return null}floorMod(t,e){return t-e*Math.floor(t/e)}interpolateValue(t,e){const i=t,s=t+1,a=e,o=e+1;let n;if(n=this.grid[a]){const r=n[i],c=n[s];if(this.isValue(r)&&this.isValue(c)&&(n=this.grid[o])){const h=n[i],l=n[s];if(this.isValue(h)&&this.isValue(l))return W(0,0,r,c,h,l)}}return 0}isValue(t){return t!=null}drawImage(t){const e=this._canvas,i=e.getContext("2d",{willReadFrequently:!0});i.clearRect(0,0,3e3,3e3);const s=t.length,a=t[0].length;e.height=s,e.width=a;const o=i.getImageData(0,0,a,s),n=o.data;let r=0;for(let c=0;c<s;c++){const h=t[c];for(let l=0;l<a;l++){const d=h[l];if(d!==null){const f=this.getColor(d),m=this.colorRgba(f,this.opacity);m&&(n[r]=m[0],n[r+1]=m[1],n[r+2]=m[2],n[r+3]=m[3])}r=r+4}}i.putImageData(o,0,0)}getColor(t){t=Number(t);const e=this.legendVal,i=e.length;let s="";if(i){for(let a=0;a<i;a++)if(t>=e[a]){s=this.legendColor[a];break}if(!s)for(let a=0;a<i;a++)t<=e[a]&&(s=this.legendColor[a])}else return!1;return s}colorRgba(t,e){const i=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;let s=t.toLowerCase();if(i.test(s)){if(s.length===4){let o="#";for(let n=1;n<4;n+=1)o+=s.slice(n,n+1).concat(s.slice(n,n+1));s=o}const a=[];for(let o=1;o<7;o+=2)a.push(parseInt("0x"+s.slice(o,o+2)));return a.push(e*255),a}else return s}getBound(){const t=this.latStart-(this.ny-1)*this.dy,e=this.lngStart+(this.nx-1)*this.dx;return[[this.lngStart,t],[e,this.latStart]]}getContent(t){if(!t)return null;const e=this.interpolate(t.lng,t.lat);if(e!==null){const i=this.options.formatter?this.options.formatter(e):e.toFixed(2);return"<li>"+this.options.name+"\uFF1A"+i+this.unit+"</li><li>\u7ECF\u5EA6\uFF1A"+t.lng.toFixed(2)+"</li><li>\u7EAC\u5EA6\uFF1A"+t.lat.toFixed(2)+"</li>"}else return null}getImageUrl(){return new Promise(t=>{this.needBuild&&this.buildGrid(this.data);try{this.drawImage(this.grid)}catch{this._createCanvas(),this.drawImage(this.grid)}t(this._canvas.toDataURL())})}destroy(){this._removeCanvas(this._viewer.container),this._viewer.off("click",this._onMouseClick,this),this.clearPopup()}_onMouseClick(t){const e=this.getContent(t.latLng);e!==null?this._viewer.openPopup(this.options.title,e,t.earthPosition,{}):this._viewer.closePopup()}}class H{constructor(t,e,i,s){p(this,"viewer");p(this,"era5Data");p(this,"legend");p(this,"imageCreator");p(this,"imgLayer");p(this,"doc",document.getElementById("cesiumContainer"));p(this,"labelDiv",document.createElement("div"));p(this,"text");p(this,"instance");p(this,"app");p(this,"siteInfo");p(this,"activeData");this.viewer=t,this.era5Data=e,this.legend=s,this.init(i)}init(t){if(this.viewer){const e={legendName:"\u6C14\u6E29",legendUnit:"(\xB0C)",legendValList:[40,38,36,34,32,30,28,26,24,22,20,18,16,14,12,10,8,6,4,2,0,-2,-4,-6,-8,-10,-12,-14,-16,-18,-20,-22,-24,-26,-28,-30,-32,-34,-36,-38,-40],legendColorList:["#670000","#800500","#9A0A00","#B30F00","#CC3C00","#E66A00","#FF9700","#FFCB00","#FFFF00","#C2F10E","#84E31C","#47D52B","#09C739","#1EE392","#33FFEA","#9EF7F7","#CBFBFB","#A9CDF7","#879FF3","#6671EF","#4443EB","#5B5AE6","#7170E1","#8887DC","#9F9ED6","#B5B5D1","#CCCCCC","#BEC6CB","#A3BAC9","#96B4C8","#88AEC7","#7AA8C6","#6DA2C5","#5F9CC4","#5296C3","#4490C2","#368AC1","#2984C0","#1B7EBF","#0E78BE","#0072BD"],min:-2.16,max:32.06,space:!0};this.imageCreator=new U({legendColor:e.legendColorList,legendVal:e.legendValList,opacity:.8});const i=this.era5Data[0];let s,a,o,n;t?(s=t.maxLon,a=t.minLon,o=t.maxLat,n=t.minLat):(s=i[0][0],a=s,o=i[0][1],n=o);let r=[];if(t)r=this.era5Data;else for(let h=0;h<this.era5Data.length;h++){r.push([]);for(let l=0;l<this.era5Data[h].length;l++){const d=this.era5Data[h][l][0],f=this.era5Data[h][l][1];s=Math.max(s,d),o=Math.max(o,f),a=Math.min(a,d),n=Math.min(n,f),r[h][l]=this.era5Data[h][l][2]}}const c={lo1:a,lo2:s,la1:n,la2:o,dx:.25,dy:.25,nx:this.era5Data[0].length,ny:this.era5Data.length};this.imageCreator.setHeader(c),this.imageCreator.setGrids(r),this.imageCreator.getImageUrl().then(h=>{this.imgLayer=this.viewer.scene.primitives.add(new Cesium.GroundPrimitive({geometryInstances:new Cesium.GeometryInstance({geometry:new Cesium.RectangleGeometry({rectangle:Cesium.Rectangle.fromDegrees(a,n,s,o),vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT})}),appearance:new Cesium.EllipsoidSurfaceAppearance({aboveGround:!1,material:new Cesium.Material({fabric:{type:"Image",uniforms:{image:h}}})})})),this.viewer.camera.flyTo({destination:Cesium.Rectangle.fromDegrees(a,n,s,o)})})}}getData(t,e){for(let i=0;i<this.era5Data.length;i++)this.era5Data[i][0]==t&&this.era5Data[i][0]==e}initPop(){this.viewer}callback(t){const e=Number(t.latLng.longitude),i=Number(t.latLng.latitude);if(this.activeData&&this.activeData[0]-.125<=e&&e<=this.activeData[0]+.125&&this.activeData[1]-.125<=i&&i<=this.activeData[1])return;let s=!1;for(let a=0;a<this.era5Data.length;a++)if(this.era5Data[a][0][1]-.125<=i&&i<=this.era5Data[a][0][1]+.125)for(let o=0;o<this.era5Data[a].length;o++)this.era5Data[a][o][0]-.125<=e&&e<=this.era5Data[a][o][0]&&this.imageCreator&&(s=!0,this.activeData=this.era5Data[a][o],this.siteInfo=this.era5Data[a][o],this.initMouseLabel(this.era5Data[a][o]));!s&&this.instance&&(this.instance.$el.remove(),this.app.unmount())}initMouseLabel(t){this.instance&&(this.instance.$el.remove(),this.app.unmount());const e=document.createElement("div");this.app=b({render(){return F(O)}}),this.app.config.globalProperties.$era5data=t,this.instance=this.app.mount(e),this.viewer&&this.viewer.cesiumWidget.container.appendChild(this.instance.$el),this.instance.$el.style.display="block",this.postRender()}addPostRender(){this.viewer&&this.viewer.scene.postRender.addEventListener(this.postRender,this)}postRender(){if(!this.instance.$el||!this.instance.$el.style)return;const t=this.viewer&&this.viewer.scene.canvas.height,e=new Cesium.Cartesian2,i=Cesium.Cartesian3.fromDegrees(this.siteInfo[0],this.siteInfo[1],0);Cesium.SceneTransforms.wgs84ToWindowCoordinates(this.viewer&&this.viewer.scene,i,e),this.instance.$el.style.bottom=t-e.y+10+"px";const s=this.instance.$el.offsetWidth;this.instance.$el.style.left=e.x-s/2+120+"px"}clear(){this.instance&&(this.instance.$el.remove(),this.app.unmount()),this.imgLayer&&this.viewer&&this.viewer.imageryLayers.remove(this.imgLayer),this.activeData=void 0}}const ot=A({__name:"index",setup(u){let t=null;B(()=>{e()});async function e(){try{const s=await fetch("/weather.json");if(!s.ok)throw new Error("Network response was not ok");const a=await s.json();i(a)}catch(s){console.error("Error fetching JSON data:",s)}}function i(s){t&&(t.clear(),t=null),t=new H(window.viewer,s.matrix,{minLon:s.bbox[0],maxLon:s.bbox[2],minLat:s.bbox[1],maxLat:s.bbox[3]})}return(s,a)=>(v(),R(L(y),null,{default:M(()=>a[0]||(a[0]=[g("div",{class:"lg:flex"},null,-1)])),_:1}))}});export{ot as default};
